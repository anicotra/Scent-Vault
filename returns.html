<!DOCTYPE html>
<html lang="en" ng-app="returnsApp">

<head>
    <meta charset="UTF-8">
    <title>Returns Center | Scent Vault</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .order-card, .reason-option { padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .order-card.selected, .reason-option.selected { border-color: #0d6efd; background-color: #f8f9fa; }
        .product-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 10px; }
    </style>
</head>

<body ng-controller="ReturnsController">
    <div class="container">
        <h2>Returns Center</h2>

        <!-- Step 1 -->
        <div ng-show="currentStep === 1">
            <h4>Find Your Order</h4>
            <div class="alert alert-info">Enter your email or confirmation number to search for your order.</div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label>Email Address</label>
                    <input type="email" class="form-control" ng-model="search.email">
                </div>
                <div class="col-md-6">
                    <label>Order Number</label>
                    <input type="text" class="form-control" ng-model="search.orderNumber">
                </div>
            </div>
            <button class="btn btn-primary" ng-click="findOrders()">Find Orders</button>
            <a href="index.html" class="btn btn-outline-secondary ms-2">Back to Home</a>

            <div class="mt-4" ng-if="orders.length > 0">
                <div class="order-card" ng-repeat="order in orders" ng-click="selectOrder(order)"
                    ng-class="{'selected': selectedOrder && selectedOrder.confirmationNumber === order.confirmationNumber}">
                    <h5>Order #{{order.confirmationNumber}}</h5>
                    <p>Placed on {{order.date | date:'mediumDate'}}<br>Total: ${{order.total.toFixed(2)}}</p>
                    <span class="badge bg-secondary">{{order.items.length}} items</span>
                </div>
                <button class="btn btn-primary mt-2" ng-disabled="!selectedOrder" ng-click="goToStep(2)">Continue With Selected Order</button>
            </div>
        </div>

        <!-- Step 2 -->
        <div ng-show="currentStep === 2">
            <h4>Select Items to Return</h4>
            <p>Order #{{selectedOrder.confirmationNumber}} - {{selectedOrder.date | date:'mediumDate'}}</p>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr><th></th><th>Image</th><th>Product</th><th>Price</th><th>Quantity</th></tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="item in selectedOrder.items">
                            <td><input type="checkbox" ng-model="item.selected" ng-change="updateSelectedItems()"></td>
                            <td><img ng-src="{{item.image}}" class="product-img"></td>
                            <td>{{item.name}}</td>
                            <td>${{item.price.toFixed(2)}}</td>
                            <td>
                                <select class="form-select" ng-model="item.returnQty" ng-options="n for n in getQuantityArray(item.quantity)"></select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-secondary" ng-click="goToStep(1)">Back</button>
                <button class="btn btn-primary" ng-disabled="selectedItems.length === 0" ng-click="goToStep(3)">Continue</button>
            </div>
        </div>

        <!-- Step 3 -->
        <div ng-show="currentStep === 3">
            <h4>Return Reason</h4>
            <div class="d-flex flex-wrap mb-3">
                <div class="reason-option" ng-repeat="reason in returnReasons" ng-click="selectReason(reason)"
                    ng-class="{'selected': returnData.reason === reason.value}">
                    {{reason.label}}
                </div>
            </div>
            <div ng-show="returnData.reason === 'other'" class="mb-3">
                <label>Details:</label>
                <textarea class="form-control" ng-model="returnData.details" rows="3"></textarea>
            </div>
            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-secondary" ng-click="goToStep(2)">Back</button>
                <button class="btn btn-primary" ng-click="goToStep(4)">Continue</button>
            </div>
        </div>

        <!-- Step 4 -->
        <div ng-show="currentStep === 4">
            <h4>Review Your Return</h4>
            <table class="table">
                <thead><tr><th>Product</th><th>Qty</th><th>Refund</th></tr></thead>
                <tbody>
                    <tr ng-repeat="item in selectedItems">
                        <td>{{item.name}}</td>
                        <td>{{item.returnQty}}</td>
                        <td>${{(item.price * item.returnQty).toFixed(2)}}</td>
                    </tr>
                </tbody>
            </table>
            <div class="text-end">
                <p>Subtotal: ${{calculateRefundSubtotal().toFixed(2)}}</p>
                <p>Tax: ${{(calculateRefundSubtotal() * 0.06).toFixed(2)}}</p>
                <h5>Total Refund: ${{calculateTotalRefund().toFixed(2)}}</h5>
            </div>
            <p>Reason: {{getReasonLabel(returnData.reason)}}<br>{{returnData.details}}</p>
            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-secondary" ng-click="goToStep(3)">Back</button>
                <button class="btn btn-primary" ng-click="submitReturn()">Submit Return</button>
            </div>
        </div>
    </div>

    <script>
        angular.module('returnsApp', [])
        .controller('ReturnsController', ['$scope', function($scope) {
            $scope.currentStep = 1;
            $scope.search = { email: '', orderNumber: '' };
            $scope.orders = [];
            $scope.selectedOrder = null;
            $scope.selectedItems = [];
            $scope.returnData = { reason: '', details: '' };

            $scope.returnReasons = [
                { value: 'wrong-item', label: 'Wrong Item Received' },
                { value: 'defective', label: 'Defective/Damaged' },
                { value: 'not-as-described', label: 'Not As Described' },
                { value: 'no-longer-needed', label: 'No Longer Needed' },
                { value: 'better-price', label: 'Found Better Price' },
                { value: 'other', label: 'Other Reason' }
            ];

            $scope.getQuantityArray = function(max) {
                return Array.from({ length: max }, (_, i) => i + 1);
            };

            $scope.findOrders = function() {
                // Load all saved orders
                const all = JSON.parse(localStorage.getItem('orders') || '[]');
                const e = $scope.search.email.trim().toLowerCase();
                const n = $scope.search.orderNumber.trim();

                $scope.orders = all.filter(o => {
                    const emailMatch = e && o.shipping.address.email.toLowerCase() === e;
                    const numMatch = n && o.confirmationNumber === n;
                    return emailMatch || numMatch;
                }).map(o => ({
                    confirmationNumber: o.confirmationNumber,
                    date: new Date(o.date),
                    items: o.items,
                    shipping: o.shipping,
                    total: o.items.reduce((sum,i) => sum + i.price * (i.quantity||1), 0) * 1.06 +
                           (o.shipping.method==='standard'?5.99:(o.shipping.method==='express'?12.99:24.99))
                }));

                if ($scope.orders.length === 0) return alert('No matching orders found.');
                $scope.goToStep(1);
            };

            $scope.selectOrder = function(order) {
                // find full order object by confirmationNumber
                const full = JSON.parse(localStorage.getItem('orders') || '[]')
                    .find(o => o.confirmationNumber === order.confirmationNumber);
                $scope.selectedOrder = angular.copy(full);
                $scope.selectedOrder.items.forEach(i => { i.selected = false; i.returnQty = i.quantity; });
                $scope.goToStep(2);
            };

            $scope.updateSelectedItems = function() {
                $scope.selectedItems = $scope.selectedOrder.items.filter(i => i.selected);
            };

            $scope.selectReason = function(reason) { $scope.returnData.reason = reason.value; if(reason.value!=='other') $scope.returnData.details=''; };
            $scope.getReasonLabel = function(val) { return ($scope.returnReasons.find(r=>r.value===val)||{}).label; };
            $scope.calculateRefundSubtotal = function() { return $scope.selectedItems.reduce((s,i)=>s + i.price * i.returnQty, 0); };
            $scope.calculateTotalRefund = function() { const sub=$scope.calculateRefundSubtotal(); return sub + sub*0.06; };
            $scope.goToStep = function(step) { $scope.currentStep = step; };
            $scope.submitReturn = function() { alert('Return submitted successfully!'); $scope.currentStep=1; };
        }]);
    </script>
</body>

</html>


















